"undefined"==typeof fcf&&"object"==typeof module&&"undefined"!=typeof module.filename&&require("fcf-framework-core"),fcf.module({name:"fcf-framework-unitest:unitest.js",dependencies:[],lazy:[],module:()=>{let a=fcf.prepare(fcf,"NUnitest");return fcf.addException("UNITEST_EQUAL","\"@{{left}}@\" and \"@{{right}}@\" are not equal"),fcf.addException("UNITEST_NOT_EQUAL","\"@{{left}}@\" and \"@{{right}}@\" are equal"),fcf.addException("UNITEST_LESS","\"@{{left}}@\" is not less than \"@{{right}}@\""),fcf.addException("UNITEST_LESS_EQUAL","\"@{{left}}@\" is not less than \"@{{right}}@\" or not equal"),fcf.addException("UNITEST_GREATER","\"@{{left}}@\" is not greater than \"@{{right}}@\""),fcf.addException("UNITEST_GREATER_EQUAL","\"@{{left}}@\" is not greater than \"@{{right}}@\" or not equal"),fcf.addException("UNITEST_ERROR","@{{error}}@"),fcf.addException("UNUTEST_WEB_COMMAND_UNSET","Web unit test command not installed for unitest.run() (Options: webProcesses.command)"),fcf.addException("UNITEST_ERROR_EXEC_COMMAND","Child process \"@{{process}}@\" exited with an error"),fcf.addException("UNITEST_FAILD_BROWSER_TEST","Failed to run test in browser. Command: \"@{{command}}@\". @{{error}}@"),fcf.addException("UNITEST_FAILD_SEND_MESSAGE","Failed to send message to test server \"@{{url}}@\""),fcf.addException("UNITEST_TIMEOUT","Test timed out"),a.Unitest=class{constructor(a){this._isRoot=!a,this._tests=a?fcf.NUnitest.unitest._tests:{}}add(a,b,c,d){return this._isRoot?void("function"==typeof c?(d=c,c=b,b=a,a="default"):"function"==typeof b?(d=b,c=a,b="default",a="default"):"function"==typeof a&&(d=a,c=fcf.uuid(),b="default",a="default"),fcf.prepare(this._tests,[a,b]),this._tests[a][b][c]=d):void fcf.NUnitest.unitest.add.apply(fcf.NUnitest.unitest,arguments)}run(a){return this._run(a)}compare(a,b,d,e){let f=fcf.compare(b,d,e);if("!="==a){if(0==f)throw new fcf.Exception("UNITEST_NOT_EQUAL",{left:fcf.str(b),right:fcf.str(d)});}else if("="==a||"=="==a){if(0!=f)throw new fcf.Exception("UNITEST_EQUAL",{left:fcf.str(b),right:fcf.str(d)});}else if("<"==a){if(0<=f)throw new fcf.Exception("UNITEST_LESS",{left:fcf.str(b),right:fcf.str(d)});}else if("<="==a){if(0<f)throw new fcf.Exception("UNITEST_LESS_EQUAL",{left:fcf.str(b),right:fcf.str(d)});}else if(">"==a){if(0>=f)throw new fcf.Exception("UNITEST_GREATER",{left:fcf.str(b),right:fcf.str(d)});}else if(">="==a&&0>f)throw new fcf.Exception("UNITEST_GREATER_EQUAL",{left:fcf.str(b),right:fcf.str(d)})}error(a){throw new fcf.Exception("UNITEST_ERROR",{error:a instanceof Error?"Test execution error":fcf.str(a)},a instanceof Error?a:void 0)}equal(a,b,c){return this.compare("==",a,b,c)}notEqual(a,b,c){return this.compare("!=",a,b,c)}less(a,b){return this.compare("<",a,b)}lessEqual(a,b){return this.compare("<=",a,b)}greater(a,b){return this.compare(">",a,b)}greaterEqual(a,b){return this.compare(">=",a,b)}runAutoTests(a){let b=new fcf.RouteInfo(window.location.href),c=b.args.___fcf_unitest_host||"localhost",d=b.args.___fcf_unitest_port,e=b.args.___fcf_unitest_id,f=Array.isArray(b.args.___fcf_unitest_tests)?b.args.___fcf_unitest_tests:void 0,g=Array.isArray(b.args.___fcf_unitest_groups)?b.args.___fcf_unitest_groups:void 0,h=Array.isArray(b.args.___fcf_unitest_parts)?b.args.___fcf_unitest_parts:void 0,i=isNaN(b.args.___fcf_unitest_step)?0:parseInt(b.args.___fcf_unitest_step),j=b.args.___fcf_unitest_include?b.args.___fcf_unitest_include:[],k=isNaN(parseInt(b.args.___fcf_unitest_wait))?b.args.___fcf_unitest_wait:parseInt(b.args.___fcf_unitest_wait);return fcf.actions().then(()=>this._run(fcf.append({},a,{id:e,parts:h,groups:g,tests:f,include:j}),{host:c,port:d},k)).then(async()=>{if(c&&d){let a=`http://${c}:${d}/getstep`;try{++i;let b={step:i,id:e},j=await fetch(a,{method:"POST",mode:"cors",headers:{"Content-Type":"application/json"},body:JSON.stringify(b)}),k=await j.json();if(k.url){let a=new fcf.RouteInfo(k.url,"root");a.urlArgs.___fcf_unitest=void 0,a.urlArgs.___fcf_unitest_host=c,a.urlArgs.___fcf_unitest_port=d,a.urlArgs.___fcf_unitest_step=i,a.urlArgs.___fcf_unitest_groups=g,a.urlArgs.___fcf_unitest_parts=h,a.urlArgs.___fcf_unitest_tests=f,a.urlArgs.___fcf_unitest_id=e,a.urlArgs.___fcf_unitest_include=Array.isArray(k.include)?k.include:[],window.location.href=fcf.buildUrl(a)}}catch(b){throw new fcf.Exception("UNITEST_FAILD_SEND_MESSAGE",{url:a},b)}}})}_run(b,c,d){if(this._isRoot)return fcf.actions().then(()=>{let e=new a.Unitest(!0);return e._run(b,c,d)});let e=this;b=fcf.append({enableWebTests:!0,enableLocalTests:!0,processes:[],timeout:3e4,webTestingPort:4589,webBrowsers:[["google-chrome","chrome","chromium","firefox","opera","safari"]],webProcesses:[],webTestingPages:[]},b);let f={options:b,result:{errorCount:0,testCount:0,successfulCount:0,tests:[],output:[]},currentTest:void 0,currentPart:void 0,currentGroup:void 0,selfOutput:!1,originLog:void 0,originError:void 0,originWarn:void 0,outputActions:fcf.actions(),pushOutput:function(a,b,d,f,g){let h={unitest:e,part:this.currentPart,group:this.currentGroup,test:this.currentTest,level:b,source:d,executor:a,time:new Date,message:fcf.trim(fcf.append([],g).map(a=>fcf.str(a)).join(" "),["\r","\n"])};this.currentTestInfo&&this.currentTestInfo.output.push(h),this.options.onMessage&&this.options.onMessage(h),fcf.getEventChannel().send("unitest_message",h),this.result.output.push(h),c&&c.host&&c.port&&this.outputActions.then(async()=>{let a=`http://${c.host}:${c.port}/message`;try{let b=fcf.append({},h,f);delete b.unitest,b.id=this.options.id;await fetch(a,{method:"PUT",mode:"cors",headers:{"Content-Type":"application/json"},body:JSON.stringify(b)})}catch(b){throw new fcf.Exception("UNITEST_FAILD_SEND_MESSAGE",{url:a},b)}})}};f.outputActions.catch(a=>{this._err(f,a)});let g,h,i,j=[];return fcf.actions().then(async()=>{let a=f.options.include;a&&"string"==typeof a&&(a=[a]),Array.isArray(a)&&(await fcf.require(a)),g=this._quantityToOptionArray(f.options.parts),h=this._quantityToOptionArray(f.options.groups),i=this._quantityToOptionArray(f.options.tests)}).then(()=>{if("string"==typeof d){let a=fcf.resolve(window,d);return a()}return"number"==typeof d?fcf.actions().then((a,b)=>{setTimeout(()=>{b.complete()},d)}):void 0}).then(async()=>{await this._startTests(f),await this._logTestsStart(f,g,h,i)}).each(f.options.processes,(a,b,c,d)=>{if(!this._isSelected(b.tests,i))return void d.complete();if(!this._isSelected(b.groups,h))return void d.complete();if(!this._isSelected(b.parts,g))return void d.complete();let e,k=require("child_process"),l=require("fcf-framework-core/NProcess/NProcess.js"),m=l.commandFromString(b.command),n=k.spawn(m.command,m.args);j.push(n),this._log(f,`Child process "${b.command}" started with pid ${n.pid}`),n.stdout.on("data",a=>{this._log(f,`Sub process "${m.command}" stdout:`,fcf.Logger.offset(4,` [${m.command} PID: ${n.pid}]> `),"\n",a.toString())}),n.stderr.on("data",a=>{this._err(f,`Sub process "${m.command}" stderr:`,fcf.Logger.offset(4,` [PID: ${n.pid}]> `),"\n",a.toString())}),n.on("error",()=>{clearTimeout(e),d.error(new fcf.Exception("UNITEST_ERROR_EXEC_COMMAND",{process:b.command}))}),n.on("exit",a=>{clearTimeout(e),a?d.error(new fcf.Exception("UNITEST_ERROR_EXEC_COMMAND",{process:b.command})):d.complete()}),j.push(n),e=setTimeout(()=>{d.complete()},b.startTimeout||1e3)}).then(()=>{if(f.options.enableLocalTests)return this._runLocalTests(f,g,h,i)}).then(()=>{if(f.options.enableWebTests&&!fcf.empty(f.options.webTestingPages))return this._runWebTests(f,g,h,i)}).then(()=>this._logTestsEnd(f)).finally(()=>fcf.actions().then((a,b)=>{f.outputActions.finally(()=>{b.complete()})}).then(()=>this._endTests(f))).finally(()=>{for(let a of j)try{a.kill()}catch(a){}}).then(()=>f.result)}async _runLocalTests(a,b,c,d){let e=[];for(let f in this._tests)if(!(b&&-1==b.indexOf(f)))for(let a in this._tests[f])if(!(c&&-1==c.indexOf(a)))for(let b in this._tests[f][a])d&&-1==d.indexOf(b)||e.push({part:f,group:a,name:b,test:this._tests[f][a][b]});e.length&&(this._log(a,""),this._log(a,"Start local tests..."),this._log(a,"--------------------"));for(let f of e){a.currentPart=f.part,a.currentGroup=f.group,a.currentTest=f.name,a.currentTestInfo={part:f.part,group:f.group,test:f.name,executor:fcf.isServer()?"server":"browser",status:void 0,error:void 0,output:[]},this._logEx(a,{command:"start_test"},`Test [${a.currentPart}][${a.currentGroup}][${a.currentTest}] running ...`);let b;try{await fcf.actions().then(async(c,d)=>{b=setTimeout(()=>{d.error(new fcf.Exception("UNITEST_TIMEOUT"))},a.options.timeout),await f.test(this),d.complete()}),a.currentTestInfo.status="ok",this._logEx(a,{command:"end_test",error:void 0},`Test [${a.currentPart}][${a.currentGroup}][${a.currentTest}] is completed.`)}catch(b){a.currentTestInfo.status="error",a.currentTestInfo.error=this._getErrorInfo(b),this._errEx(a,{command:"end_test",error:b},`Test [${a.currentPart}][${a.currentGroup}][${a.currentTest}] is failed. \n`+`Position: ${a.currentTestInfo.error.file}:${a.currentTestInfo.error.line}\n`+`Error:   `,fcf.str(a.currentTestInfo.error.error,!0))}clearTimeout(b),a.result.tests.push(a.currentTestInfo),"error"==a.currentTestInfo.status?++a.result.errorCount:++a.result.successfulCount,++a.result.testCount,a.currentTestInfo=void 0}a.currentPart=void 0,a.currentGroup=void 0,a.currentTest=void 0,a.currentTestInfo=void 0}async _runWebTests(a,b,c,d){if(fcf.empty(a.options.webTestingPages)||!fcf.isServer())return;let e,f=require("child_process"),g=require("fcf-framework-core/NProcess/NProcess.js"),h=require("fcf-framework-unitest/NDetails/BackServer.js"),i=[];return fcf.actions().then(()=>{this._log(a,""),this._log(a,"Start web tests..."),this._log(a,"--------------------")}).each(a.options.webProcesses,async(e,h,j,k)=>{if(!this._isSelected(h.tests,d))return void k.complete();if(!this._isSelected(h.groups,c))return void k.complete();if(!this._isSelected(h.parts,b))return void k.complete();let l,m;if(fcf.empty(h.command)||!Array.isArray(h.command)&&"string"!=typeof h.command)throw new fcf.Exception("UNUTEST_WEB_COMMAND_UNSET",{});let n,o,p=Array.isArray(h.command)?g.commandToString(h.command):h.command;if(Array.isArray(h.command))o=fcf.clone(h.command),n=o.shift();else{let a=g.commandFromString(h.command);n=a.command,o=a.args}this._log(a,`Start process: ${p}`),m=f.spawn(n,o),i.push(m),this._log(a,`Child process "${n}" started with pid ${m.pid}`),m.stdout.on("data",b=>{this._log(a,`Sub process "${n}" stdout:`,fcf.Logger.offset(4,` [${n} PID: ${m.pid}]> `),"\n",b.toString())}),m.stderr.on("data",b=>{this._err(a,`Sub process "${n}" stderr:`,fcf.Logger.offset(4,` [PID: ${m.pid}]> `),"\n",b.toString())}),m.on("error",()=>{clearTimeout(l),k.error(new fcf.Exception("UNITEST_ERROR_EXEC_COMMAND",{process:p}))}),m.on("exit",a=>{clearTimeout(l),a&&k.error(new fcf.Exception("UNITEST_ERROR_EXEC_COMMAND",{process:p}))}),l=setTimeout(()=>{k.complete()},isNaN(h.startTimeout)?1e3:h.startTimeout)}).then(()=>(this._log(a,`Start back server on port ${a.options.webTestingPort}`),e=new h(a.options.webTestingPort,a.options.webTestingPages),e.run())).each(a.options.webBrowsers,async(b,c)=>{c=Array.isArray(c)?c:[c];let d,h,j;for(let k,l=0;l<c.length;++l){k=fcf.id(),d=void 0;try{let b,d;await fcf.actions().then((i,m)=>{h=c[l],-1==h.indexOf("{{")&&(h+=" \"@{{url}}@\"");let n=Array.isArray(a.options.webTestingPages[0].include)?a.options.webTestingPages[0].include:"string"==typeof a.options.webTestingPages[0].include?[a.options.webTestingPages[0].include]:[],o=a.options.webTestingPages[0].url;o+=-1==o.indexOf("?")?"?":"&",o+=`___fcf_unitest&___fcf_unitest_host=localhost&`+`___fcf_unitest_port=${a.options.webTestingPort}&`+`___fcf_unitest_tests=${encodeURIComponent(JSON.stringify(a.options.tests))}&`+`___fcf_unitest_groups=${encodeURIComponent(JSON.stringify(a.options.groups))}&`+`___fcf_unitest_parts=${encodeURIComponent(JSON.stringify(a.options.parts))}&`+`___fcf_unitest_id=${k}&`+(a.options.webTestingPages[0].wait?`___fcf_unitest_wait=${a.options.webTestingPages[0].wait}&`:"")+`___fcf_unitest_include=${encodeURIComponent(JSON.stringify(n))}`,h=fcf.tokenize(h,{url:o},{quiet:!0});let p=g.commandFromString(h);e.setId(k),e.onStep(b=>{if(Array.isArray(a.options.webTestingPages)&&a.options.webTestingPages[b]&&a.options.webTestingPages[b].url){let c=a.options.webTestingPages[b],d=new fcf.RouteInfo(a.options.webTestingPages[b].url,"root");d.urlArgs.___fcf_unitest=void 0,d.urlArgs.___fcf_unitest_host="localhost",d.urlArgs.___fcf_unitest_port=a.options.webTestingPort,d.urlArgs.___fcf_unitest_include=Array.isArray(c.include)?c.include:[],d.urlArgs.___fcf_unitest_step=b,d.urlArgs.___fcf_unitest_id=k,d.urlArgs.___fcf_unitest_wait=a.options.webTestingPages[b].wait;let e=fcf.buildUrl(d);this._msg(a,p.command,{unitest:this,part:void 0,group:void 0,test:void 0,level:"log",source:"UniTest",executor:p.command,time:new Date,message:`Go to page ${e}`})}else j=!0,d&&clearTimeout(d),m.complete()}),e.onMessage(b=>{b.test&&("start_test"==b.command?(clearTimeout(d),d=setTimeout(()=>{j=!0,m.error(new Error(`[${b.part}][${b.group}][${b.test}] test timed out`))},a.options.timeout),a.currentTestInfo={part:b.part,group:b.group,test:b.test,executor:p.command,status:void 0,error:void 0,output:[]}):"end_test"==b.command&&a.currentTestInfo&&(clearTimeout(d),d=setTimeout(()=>{j=!0,m.error(new Error("Browser command timed out"))},a.options.timeout),a.currentTestInfo.status=b.error?"error":"ok",a.currentTestInfo.error=b.error,a.result.tests.push(a.currentTestInfo),"error"==a.currentTestInfo.status?++a.result.errorCount:++a.result.successfulCount,++a.result.testCount,a.currentTestInfo=void 0),this._msg(a,p.command,b))}),this._log(a,`Start browser '${h}' ...`),b=f.spawn(p.command,p.args),b.on("error",()=>{clearTimeout(d),this._err(a,`Failed start browser 2'${h}'`),m.error(new Error(`browser '${h}' exited with an error.`))}),clearTimeout(d),d=setTimeout(()=>{j=!0,m.error(new Error(`Page "${o}" test timed out`))},a.options.timeout)}).finally(()=>{b&&b.kill(),d&&(clearTimeout(d),d=void 0)}).then(()=>{j=!0})}catch(a){d=a}if(j)break}if(d)throw new fcf.Exception("UNITEST_FAILD_BROWSER_TEST",{command:h,error:d})}).finally(()=>{e.stop();for(let a of i)try{a.kill()}catch(a){}})}async _startTests(a){a.originLog=console.log,console.log=function(){a.selfOutput||a.pushOutput("server","log","",{},arguments),a.originLog.apply(console,arguments)},a.originWarn=console.warn,console.warn=function(){a.selfOutput||a.pushOutput("server","warning","",{},arguments),a.originWarn.apply(console,arguments)},a.originError=console.error,console.error=function(){a.selfOutput||a.pushOutput("server","error","",{},arguments),a.originError.apply(console,arguments)},a.logEventHandlerBefore=function(){a.selfOutput||(a.selfLoggerOutput=!0,a.selfOutput=!0)},fcf.log.on("message_before",a.logEventHandlerBefore),a.logEventHandlerAfter=function(b){(!a.selfOutput||a.selfLoggerOutput)&&a.pushOutput("server",b.level,b.module,{},b.args),a.selfOutput&&a.selfLoggerOutput&&(a.selfLoggerOutput=!1,a.selfOutput=!1)},fcf.log.on("message_after",a.logEventHandlerAfter)}_endTests(a){a.originLog&&(console.log=a.originLog),a.originWarn&&(console.warn=a.originWarn),a.originError&&(console.error=a.originError),fcf.log.detach(a.logEventHandlerBefore),fcf.log.detach(a.logEventHandlerAfter)}_logTestsStart(a,b,c,d){this._log(a,"===================================================="),this._log(a,`Start testing${fcf.isServer()?" on the server side...":""}`),this._log(a,`Parts:  ${b?b.join("; "):"*"}`),this._log(a,`Groups: ${c?c.join("; "):"*"}`),this._log(a,`Tests:  ${d?d.join("; "):"*"}`)}_logTestsEnd(a){let b=a.result.tests.filter(a=>!!a.error).map(a=>`Executor ${a.executor}:  [${a.part}][${a.group}][${a.test}]`).join(";\n");this._log(a,""),this._log(a,"----------------------------------------------------"),this._log(a,`${a.result.testCount} test${1<a.result.testCount?"s":""} have been completed.`),this._log(a,`Errors: ${a.result.errorCount}; Successfully: ${a.result.successfulCount}; Total: ${a.result.testCount}`),b&&this._log(a,`Tests that failed: \n${b}`)}_msg(a,b,c){a.selfOutput=!0,a.pushOutput(b,c.level,c.source,{},[c.message]),a.options.quiet||fcf.log.log.apply(fcf.log,fcf.append([`${c.source}; BROWSER:${b}`],[c.message])),a.selfOutput=!1}_log(a){let b=fcf.append([],arguments);b.shift(),a.selfOutput=!0,a.pushOutput("server","log","UniTest",{},b),a.options.quiet||fcf.log.log.apply(fcf.log,fcf.append(["UniTest"],b)),a.selfOutput=!1}_logEx(a){let b=fcf.append([],arguments);b.shift();let c=b.shift();a.selfOutput=!0,a.pushOutput("server","log","UniTest",c,b),a.options.quiet||fcf.log.log.apply(fcf.log,fcf.append(["UniTest"],b)),a.selfOutput=!1}_err(a){let b=fcf.append([],arguments);b.shift(),a.selfOutput=!0,a.pushOutput("server","error","UniTest",{},b),a.options.quiet||fcf.log.err.apply(fcf.log,fcf.append(["UniTest"],b)),a.selfOutput=!1}_errEx(a){let b=fcf.append([],arguments);b.shift();let c=b.shift();a.selfOutput=!0,a.pushOutput("server","error","UniTest",c,b),a.options.quiet||fcf.log.log.apply(fcf.log,fcf.append(["UniTest"],b)),a.selfOutput=!1}_getErrorInfo(a){let b=fcf.parseStack(a),c=b.find(a=>!(a.function&&a.file)||a.function&&0!=a.function.indexOf("Namespace.Unitest.")&&-1==a.file.indexOf("fcf-framework-unitest/unitest.js")&&("Exception"!=a.function||-1==a.file.indexOf("/fcf.js")));return{message:fcf.str(a),error:a,file:c?c.file:"unknown",line:c?c.line:"unknown"}}_quantityToOptionArray(a){return Array.isArray(a)?a:"string"==typeof a&&a.split(";")}_isSelected(a,b){if(a=this._quantityToOptionArray(a),b=this._quantityToOptionArray(b),!b||!a)return!0;let c=!1;for(let d of a)if(-1!=b.indexOf(d)){c=!0;break}return c}},a.unitest=new a.Unitest,a.unitest}});